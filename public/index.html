<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.16.0/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.16.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <!-- end -->
    <!--  -->
    <!--
      sweet alert
    -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="sweetalert2.all.min.js"></script>
    <!-- end -->
    <!--  -->
    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
    <div id="message">
      <h2>Welcome</h2>
      <h1>Firebase Hosting Setup Complete</h1>
      <p>You're seeing this because you've successfully setup Firebase Hosting. Now it's time to go build something extraordinary!</p>
      <a target="_blank" href="https://firebase.google.com/docs/hosting/">Open Hosting Documentation</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

<!-- sweet alert -->
    <script>
        // isSuccess = true 
        //  > success alert
        // isSuccess = false 
        //  > error alert
        function showAlert(isSuccess) {
          if(isSuccess === true) {
            Swal.fire({
              position: 'center',
              icon: 'success',
              title: 'ê°ì‚¬í•©ë‹ˆë‹¤. ',
              text: 'ì˜ê²¬ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
              confirmButtonColor:'#7cd1f9',
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'ì•—...',
              text: 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              confirmButtonColor:'#e64942',
            });
          }
        }
    </script>
<!-- !end! sweet alert -->

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadEl = document.querySelector('#load');
        // // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.firestore().doc('/foo/bar').get().then(() => { });
        // firebase.functions().httpsCallable('yourFunction')().then(() => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        // firebase.analytics(); // call to activate
        // firebase.analytics().logEvent('tutorial_completed');
        // firebase.performance(); // call to activate
        //
        // // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

        try {
          let app = firebase.app();
          let features = [
            'auth', 
            'database', 
            'firestore',
            'functions',
            'messaging', 
            'storage', 
            'analytics', 
            'remoteConfig',
            'performance',
          ].filter(feature => typeof app[feature] === 'function');
          loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
          console.log('firebase.app > ', app);
        } catch (e) {
          console.error(e);
          loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
        }
      });
    </script>

    
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
      //
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCxLDtEm0OdYuyS73c7AIGLHkQMGjpxwz8",
        authDomain: "picutest-ebdff.firebaseapp.com",
        databaseURL: "https://picutest-ebdff-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "picutest-ebdff",
        storageBucket: "picutest-ebdff.appspot.com",
        messagingSenderId: "817717607015",
        appId: "1:817717607015:web:8d1618b76ff05cd7b972c2"
      };
      //
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = firebase.database();
      //////////////////////////////////////////////////////////
      console.log('initializeApp > ', app);
      console.log('firebase > ', firebase);
      console.log('database > ', database);

      // get data from database / put data into database
      function putEval(letterTitle, userEmail, userEval) {
        const dbRef = database.ref(`${letterTitle}/${userEmail}/`);
        // dbRef.on('value', onSnapshot, {onlyOnce: true});  // ê°€ì ¸ì˜¤ê¸°ëŠ” í•¨. ë­ ë‹¤ ì¢‹ìŒ. ê·¼ë° ref.on('value', callbackFunc); ë‘ ref.on('child_added', callbackFunc); ë‘ ì°¨ì´ë¥¼ ëª¨ë¥´ê² ìŒ
        // dbRef.on('child_added', onSnapshot); // ê°€ì ¸ì˜¤ê¸°ëŠ” í•¨. ë­ ë‹¤ ì¢‹ìŒ. ê·¼ë° ref.on('value', callbackFunc); ë‘ ref.on('child_added', callbackFunc); ë‘ ì°¨ì´ë¥¼ ëª¨ë¥´ê² ìŒ
        dbRef.push().set({email: userEmail, eval: userEval, time: getNowTimeStr(), param: location.search});  // ì“°ê¸´ ì“°ëŠ”ë° key ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ë²„ë¦¼ ref ë‘ data êµ¬ì¡°ë§Œ ì˜ ì¡ìœ¼ë©´ ë  ë“¯ 
        //////////////////////////////////////////////////////////
        console.log('ref > ', dbRef);
      }

      // call back functions for database action
      function onSnapshot(snapshot) {
        const data = snapshot.val();
        //////////////////////////////////////////////////////////
        console.log('onSnapshot > data', data );
      }
      
      // db refs
      // https://softauthor.com/learn-to-build-firebase-crud-app-with-javascript-part01-reading-data/
      // https://www.slidesmaker.me/blog/firebase-realtime-database-crud-operations-javascript
      //
      // // ref functions
      // firebase.database().ref().child('users/').on("child_added", (snapshot) => { console.log(snapshot.key + "" + snapshot.val()); });
      // firebase.database().ref('messages/').on('value', (snapshot) => { console.log(snapshot.key + "" + snapshot.val()); });
      // firebase.database().ref('messages/').push().set({'name': 'any-data', 'email': 'any-data', 'message': 'any-data' });
      // firebase.database().ref('messages/' + 'row-id-here').update({'name': 'new-content', 'email': 'new-content', 'message': 'new-content' });
      // firebase.database().ref('messages/' + 'row-id-here').remove();
      // ref().child()
      // ref().push()
      // ref().update()
      // ref().remove()
      // ref().on()
      //
      // ì•„ë˜ë¶€í„° ì¶œì²˜ 
      // https://firebase.google.com/docs/database/web/lists-of-data?hl=ko&authuser=0
      // // on event listener
      // > child_added :	í•­ëª© ëª©ë¡ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ í•­ëª© ëª©ë¡ì— ëŒ€í•œ ì¶”ê°€ ì‚¬í•­ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤. ì´ ì´ë²¤íŠ¸ëŠ” ê° ê¸°ì¡´ ìì‹ì— ëŒ€í•´ í•œ ë²ˆ íŠ¸ë¦¬ê±°ëœ ë‹¤ìŒ ìƒˆ ìì‹ì´ ì§€ì •ëœ ê²½ë¡œì— ì¶”ê°€ë  ë•Œë§ˆë‹¤ ë‹¤ì‹œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ë¦¬ìŠ¤ë„ˆëŠ” ìƒˆ í•˜ìœ„ ë°ì´í„°ê°€ í¬í•¨ëœ ìŠ¤ëƒ…ìƒ·ì„ ì „ë‹¬ë°›ìŠµë‹ˆë‹¤.
      // > child_changed :	ëª©ë¡ì˜ í•­ëª©ì— ëŒ€í•œ ë³€ê²½ ì‚¬í•­ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤. ì´ ì´ë²¤íŠ¸ëŠ” ìì‹ ë…¸ë“œê°€ ìˆ˜ì •ë  ë•Œë§ˆë‹¤ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ìì‹ ë…¸ë“œì˜ ìì†ì— ëŒ€í•œ ëª¨ë“  ìˆ˜ì • ì‚¬í•­ì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì „ë‹¬ëœ ìŠ¤ëƒ…ìƒ·ì—ëŠ” ìì‹ì— ëŒ€í•œ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
      // > child_removed :	ëª©ë¡ì—ì„œ ì œê±°ë˜ëŠ” í•­ëª©ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤. ì´ ì´ë²¤íŠ¸ëŠ” ì§ê³„ ìì‹ì´ ì œê±°ë  ë•Œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ì½œë°± ë¸”ë¡ì— ì „ë‹¬ëœ ìŠ¤ëƒ…ìƒ·ì—ëŠ” ì œê±°ëœ ìì‹ì— ëŒ€í•œ ë°ì´í„°ê°€ í¬í•¨ë©ë‹ˆë‹¤.
      // > child_moved :	ìˆœì„œê°€ ì§€ì •ëœ ëª©ë¡ì˜ í•­ëª© ìˆœì„œì— ëŒ€í•œ ë³€ê²½ ì‚¬í•­ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤. child_moved ì´ë²¤íŠ¸ëŠ” í•­ìƒ í•­ëª©ì˜ ì£¼ë¬¸ ë³€ê²½ì„ ì•¼ê¸°í•œ child_changed ì´ë²¤íŠ¸ë¥¼ ë”°ë¦…ë‹ˆë‹¤(í˜„ì¬ order-by ë°©ë²•ì— ë”°ë¼).
      // // order function
      // > orderByChild() : 	ì§€ì •ëœ í•˜ìœ„ í‚¤ ë˜ëŠ” ì¤‘ì²©ëœ í•˜ìœ„ ê²½ë¡œì˜ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ê²°ê³¼ë¥¼ ì •ë ¬í•©ë‹ˆë‹¤.
      // > orderByKey() : 	í•˜ìœ„ í‚¤ë³„ë¡œ ê²°ê³¼ë¥¼ ì •ë ¬í•©ë‹ˆë‹¤.
      // > orderByValue() : 	í•˜ìœ„ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ê²°ê³¼ë¥¼ ì •ë ¬í•©ë‹ˆë‹¤.
      // > //filter function
      // > limitToFirst() : 	ì •ë ¬ëœ ê²°ê³¼ ëª©ë¡ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ë°˜í™˜í•  ìµœëŒ€ í•­ëª© ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      // > limitToLast() : 	ì •ë ¬ëœ ê²°ê³¼ ëª©ë¡ì˜ ëì—ì„œ ë°˜í™˜í•  ìµœëŒ€ í•­ëª© ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      // > startAt() : 	ì„ íƒí•œ order-by ë°©ë²•ì— ë”°ë¼ ì§€ì •ëœ í‚¤ ë˜ëŠ” ê°’ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì€ í•­ëª©ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
      // > startAfter() : 	ì„ íƒí•œ order-by ë°©ë²•ì— ë”°ë¼ ì§€ì •ëœ í‚¤ ë˜ëŠ” ê°’ë³´ë‹¤ í° í•­ëª©ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
      // > endAt() : 	ì„ íƒí•œ order-by ë°©ë²•ì— ë”°ë¼ ì§€ì •ëœ í‚¤ ë˜ëŠ” ê°’ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ í•­ëª©ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
      // > endBefore() : 	ì„ íƒí•œ order-by ë°©ë²•ì— ë”°ë¼ ì§€ì •ëœ í‚¤ ë˜ëŠ” ê°’ë³´ë‹¤ ì‘ì€ í•­ëª©ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
      // > equalTo() : 	ì„ íƒí•œ order-by ë°©ë²•ì— ë”°ë¼ ì§€ì •ëœ í‚¤ ë˜ëŠ” ê°’ê³¼ ë™ì¼í•œ í•­ëª©ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

      /////////////////////////////////////////////////////////////////////////////////////

      // get parameter value from url
      // http://localhost:5000/?testKey=testValue&email=hello@world.com&eval=good&title=myTest
      // title > myTest
      // email > hello@world.com
      // eval > good
      function getParamByKey(paramKey) {
        const seperator = paramKey + '=';
        const defaultResult = `uncaught value`;
        // null check
        if( !(location.search && location.search.length > 0) ) {
          return defaultResult;
        }
        //
        const searchStrList = location.search.split('?')[1].split('&');
        // null check
        if( !(searchStrList && searchStrList.length > 0)) {
          return defaultResult;
        }
        //
        const paramFullStr = searchStrList.find((ele, idx, arr)=>{
          return ele.startsWith(seperator);
        });
        // null check
        if( !(paramFullStr && paramFullStr.length > 0) ) {
          return defaultResult;
        }
        const splitList = paramFullStr.split(seperator);
        const splitResult = splitList[1];
        const escaped = splitResult.replaceAll(/[.*+?#^${}()|[\]\\]/g, '\\-');
        return escaped;
      }

      // get now time str yyyy-mm-dd hh:mm:ss
      function getNowTimeStr() {
        const timeNow = new Date();
        const year = timeNow.getFullYear();
        const month = timeNow.getMonth() > 9 ? timeNow.getMonth() : `0${timeNow.getMonth()}`;
        const day = timeNow.getDate() > 9 ? timeNow.getDate() : `0${timeNow.getDate()}`;
        const hour = timeNow.getHours() > 9 ? timeNow.getHours() : `0${timeNow.getHours()}`;
        const minute = timeNow.getMinutes() > 9 ? timeNow.getMinutes() : `0${timeNow.getMinutes()}`;
        const second = timeNow.getSeconds() > 9 ? timeNow.getSeconds() : `0${timeNow.getSeconds()}`;
        const ymd = [year, month, day].join(`-`);
        const hms = [hour, minute, second].join(`:`);
        return `${ymd} ${hms}`;
      }

      function onLoadHandler() {
        const paramKey = {letterTitle: 'title', userEmail: 'email', userEval: 'eval'};
        const letterTitle = getParamByKey(paramKey.letterTitle);
        const emailAddr = getParamByKey(paramKey.userEmail);
        const userEval = getParamByKey(paramKey.userEval);
        console.log('letterTitle', letterTitle);
        console.log('emailAddr', emailAddr);
        console.log('userEval', userEval);
        putEval(letterTitle, emailAddr, userEval);
        // showAlert(true); // TODO: puEval ì—ì„œ ë¦¬í„´ê°’ ë°›ê³  ì •ìƒ ì²˜ë¦¬ ì—¬ë¶€ í™•ì¸ í›„ì— success or error ë„ìš°ê¸°
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        onLoadHandler();
      });
    </script>
      
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.16.0/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.16.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/9.16.0/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <!-- end -->
    <!--  -->
    <!--
      sweet alert
    -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="sweetalert2.all.min.js"></script>
    <!-- end -->
    <!--  -->
    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
    <div id="message">
      <h2>Welcome</h2>
      <h1>Firebase Hosting Setup Complete</h1>
      <p>You're seeing this because you've successfully setup Firebase Hosting. Now it's time to go build something extraordinary!</p>
      <a target="_blank" href="https://firebase.google.com/docs/hosting/">Open Hosting Documentation</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

<!-- sweet alert -->
    <script>
        // isSuccess = true 
        //  > success alert
        // isSuccess = false 
        //  > error alert
        function showAlert(isSuccess) {
          if(isSuccess === true) {
            Swal.fire({
              position: 'center',
              icon: 'success',
              title: '감사합니다. ',
              text: '의견이 저장되었습니다.',
              confirmButtonColor:'#7cd1f9',
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: '앗...',
              text: '다시 시도해주세요.',
              confirmButtonColor:'#e64942',
            });
          }
        }
    </script>
<!-- !end! sweet alert -->

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadEl = document.querySelector('#load');
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.firestore().doc('/foo/bar').get().then(() => { });
        // firebase.functions().httpsCallable('yourFunction')().then(() => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        // firebase.analytics(); // call to activate
        // firebase.analytics().logEvent('tutorial_completed');
        // firebase.performance(); // call to activate
        //
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

        try {
          let app = firebase.app();
          let features = [
            'auth', 
            'database', 
            'firestore',
            'functions',
            'messaging', 
            'storage', 
            'analytics', 
            'remoteConfig',
            'performance',
          ].filter(feature => typeof app[feature] === 'function');
          loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
          console.log('firebase.app > ', app);
        } catch (e) {
          console.error(e);
          loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
        }
      });
    </script>

    
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
      //
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCxLDtEm0OdYuyS73c7AIGLHkQMGjpxwz8",
        authDomain: "picutest-ebdff.firebaseapp.com",
        databaseURL: "https://picutest-ebdff-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "picutest-ebdff",
        storageBucket: "picutest-ebdff.appspot.com",
        messagingSenderId: "817717607015",
        appId: "1:817717607015:web:8d1618b76ff05cd7b972c2"
      };
      //
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = firebase.database();
      //////////////////////////////////////////////////////////
      console.log('initializeApp > ', app);
      console.log('firebase > ', firebase);
      console.log('database > ', database);

      // get data from database / put data into database
      function putEval(letterTitle, userEmail, userEval) {
        const dbRef = database.ref(`${letterTitle}/${userEmail}/`);
        // dbRef.on('value', onSnapshot, {onlyOnce: true});  // 가져오기는 함. 뭐 다 좋음. 근데 ref.on('value', callbackFunc); 랑 ref.on('child_added', callbackFunc); 랑 차이를 모르겠음
        // dbRef.on('child_added', onSnapshot); // 가져오기는 함. 뭐 다 좋음. 근데 ref.on('value', callbackFunc); 랑 ref.on('child_added', callbackFunc); 랑 차이를 모르겠음
        dbRef.push().set({email: userEmail, eval: userEval, time: getNowTimeStr(), param: location.search});  // 쓰긴 쓰는데 key 를 자동으로 만들어버림 ref 랑 data 구조만 잘 잡으면 될 듯 
        //////////////////////////////////////////////////////////
        console.log('ref > ', dbRef);
      }

      // call back functions for database action
      function onSnapshot(snapshot) {
        const data = snapshot.val();
        //////////////////////////////////////////////////////////
        console.log('onSnapshot > data', data );
      }
      
      // db refs
      // https://softauthor.com/learn-to-build-firebase-crud-app-with-javascript-part01-reading-data/
      // https://www.slidesmaker.me/blog/firebase-realtime-database-crud-operations-javascript
      //
      // // ref functions
      // firebase.database().ref().child('users/').on("child_added", (snapshot) => { console.log(snapshot.key + "" + snapshot.val()); });
      // firebase.database().ref('messages/').on('value', (snapshot) => { console.log(snapshot.key + "" + snapshot.val()); });
      // firebase.database().ref('messages/').push().set({'name': 'any-data', 'email': 'any-data', 'message': 'any-data' });
      // firebase.database().ref('messages/' + 'row-id-here').update({'name': 'new-content', 'email': 'new-content', 'message': 'new-content' });
      // firebase.database().ref('messages/' + 'row-id-here').remove();
      // ref().child()
      // ref().push()
      // ref().update()
      // ref().remove()
      // ref().on()
      //
      // 아래부터 출처 
      // https://firebase.google.com/docs/database/web/lists-of-data?hl=ko&authuser=0
      // // on event listener
      // > child_added :	항목 목록을 검색하거나 항목 목록에 대한 추가 사항을 수신합니다. 이 이벤트는 각 기존 자식에 대해 한 번 트리거된 다음 새 자식이 지정된 경로에 추가될 때마다 다시 트리거됩니다. 리스너는 새 하위 데이터가 포함된 스냅샷을 전달받습니다.
      // > child_changed :	목록의 항목에 대한 변경 사항을 수신합니다. 이 이벤트는 자식 노드가 수정될 때마다 트리거됩니다. 여기에는 자식 노드의 자손에 대한 모든 수정 사항이 포함됩니다. 이벤트 리스너에 전달된 스냅샷에는 자식에 대한 업데이트된 데이터가 포함되어 있습니다.
      // > child_removed :	목록에서 제거되는 항목을 수신합니다. 이 이벤트는 직계 자식이 제거될 때 트리거됩니다. 콜백 블록에 전달된 스냅샷에는 제거된 자식에 대한 데이터가 포함됩니다.
      // > child_moved :	순서가 지정된 목록의 항목 순서에 대한 변경 사항을 수신합니다. child_moved 이벤트는 항상 항목의 주문 변경을 야기한 child_changed 이벤트를 따릅니다(현재 order-by 방법에 따라).
      // // order function
      // > orderByChild() : 	지정된 하위 키 또는 중첩된 하위 경로의 값을 기준으로 결과를 정렬합니다.
      // > orderByKey() : 	하위 키별로 결과를 정렬합니다.
      // > orderByValue() : 	하위 값을 기준으로 결과를 정렬합니다.
      // > //filter function
      // > limitToFirst() : 	정렬된 결과 목록의 시작 부분에서 반환할 최대 항목 수를 설정합니다.
      // > limitToLast() : 	정렬된 결과 목록의 끝에서 반환할 최대 항목 수를 설정합니다.
      // > startAt() : 	선택한 order-by 방법에 따라 지정된 키 또는 값보다 크거나 같은 항목을 반환합니다.
      // > startAfter() : 	선택한 order-by 방법에 따라 지정된 키 또는 값보다 큰 항목을 반환합니다.
      // > endAt() : 	선택한 order-by 방법에 따라 지정된 키 또는 값보다 작거나 같은 항목을 반환합니다.
      // > endBefore() : 	선택한 order-by 방법에 따라 지정된 키 또는 값보다 작은 항목을 반환합니다.
      // > equalTo() : 	선택한 order-by 방법에 따라 지정된 키 또는 값과 동일한 항목을 반환합니다.

      /////////////////////////////////////////////////////////////////////////////////////

      // get parameter value from url
      // http://localhost:5000/?testKey=testValue&email=hello@world.com&eval=good&title=myTest
      // title > myTest
      // email > hello@world.com
      // eval > good
      function getParamByKey(paramKey) {
        const seperator = paramKey + '=';
        const defaultResult = `uncaught value`;
        // null check
        if( !(location.search && location.search.length > 0) ) {
          return defaultResult;
        }
        //
        const searchStrList = location.search.split('?')[1].split('&');
        // null check
        if( !(searchStrList && searchStrList.length > 0)) {
          return defaultResult;
        }
        //
        const paramFullStr = searchStrList.find((ele, idx, arr)=>{
          return ele.startsWith(seperator);
        });
        // null check
        if( !(paramFullStr && paramFullStr.length > 0) ) {
          return defaultResult;
        }
        const splitList = paramFullStr.split(seperator);
        const splitResult = splitList[1];
        const escaped = splitResult.replaceAll(/[.*+?#^${}()|[\]\\]/g, '\\-');
        return escaped;
      }

      // get now time str yyyy-mm-dd hh:mm:ss
      function getNowTimeStr() {
        const timeNow = new Date();
        const year = timeNow.getFullYear();
        const month = timeNow.getMonth() > 9 ? timeNow.getMonth() : `0${timeNow.getMonth()}`;
        const day = timeNow.getDate() > 9 ? timeNow.getDate() : `0${timeNow.getDate()}`;
        const hour = timeNow.getHours() > 9 ? timeNow.getHours() : `0${timeNow.getHours()}`;
        const minute = timeNow.getMinutes() > 9 ? timeNow.getMinutes() : `0${timeNow.getMinutes()}`;
        const second = timeNow.getSeconds() > 9 ? timeNow.getSeconds() : `0${timeNow.getSeconds()}`;
        const ymd = [year, month, day].join(`-`);
        const hms = [hour, minute, second].join(`:`);
        return `${ymd} ${hms}`;
      }

      function onLoadHandler() {
        const paramKey = {letterTitle: 'title', userEmail: 'email', userEval: 'eval'};
        const letterTitle = getParamByKey(paramKey.letterTitle);
        const emailAddr = getParamByKey(paramKey.userEmail);
        const userEval = getParamByKey(paramKey.userEval);
        console.log('letterTitle', letterTitle);
        console.log('emailAddr', emailAddr);
        console.log('userEval', userEval);
        putEval(letterTitle, emailAddr, userEval);
        // showAlert(true); // TODO: puEval 에서 리턴값 받고 정상 처리 여부 확인 후에 success or error 띄우기
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        onLoadHandler();
      });
    </script>
      
  </body>
</html>
